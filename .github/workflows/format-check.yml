name: CI Pipeline

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  format-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check clang-format version
      run: |
        clang-format --version
        VERSION=$(clang-format --version | grep -oP '\d+\.\d+' | head -1)
        if [ "$(echo "$VERSION < 18.1" | bc -l)" -eq 1 ]; then
          echo "Error: clang-format version $VERSION is too old. Version 18.1+ required for .clang-format-ignore support."
          exit 1
        fi
        echo "clang-format version $VERSION is compatible"
        
    - name: Check code formatting
      run: |
        echo "Checking code formatting..."
        make check-format

  build:
    runs-on: ubuntu-latest
    needs: format-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Build project
      run: |
        echo "Building project..."
        make
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: calculator-binary
        path: bin/calculator

  test:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: calculator-binary
        path: bin/
        
    - name: Make binary executable
      run: chmod +x bin/calculator
        
    - name: Run tests
      run: |
        echo "Running application..."
        ./bin/calculator